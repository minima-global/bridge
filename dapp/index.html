<html>

<head>
	<title>Bridge</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- Load the main MDS JS lib -->
	<script type="text/javascript" src="./js/mds.js"></script>
	
	<!-- Load the CSS Style sheet -->
	<link rel="stylesheet" href="./css/style.css">
	
	<!-- And the ICON for the page -->
	<link rel="icon" type="image/x-icon" href="favicon.ico">
	
	<!-- Load the local JS lib -->
	<script type="text/javascript" src="./js/pagelayout.js"></script>
	<script type="text/javascript" src="./js/scripts.js"></script>
	<script type="text/javascript" src="./js/jslib.js"></script>
	<script type="text/javascript" src="./js/auth.js"></script>
	<script type="text/javascript" src="./js/sql.js"></script>
	
	<script type="text/javascript" src="./js/ethers-4.0.31.min.js"></script>
	
	<script type="text/javascript" src="./abi/tokenabi.js"></script>
	<script type="text/javascript" src="./abi/wminimaabi.js"></script>
	
	<script type="text/javascript" src="./js/ethutil.js"></script>
	
</head>

<body>

	<script type="text/javascript">
		createHeader();
	</script>
	
	Welcome to Bridge.<br>
	<br>
	Here you can Swap native Minima for wMinima on ETH.<br>
	<br>
	
	<button onclick="tester();">TEST ETH</button>
	
	<br><br>
	<button onclick="deploy();">DEPLOYED</button>
	
	<br><br>
	<button onclick="transfer();">TOKEN TRANSFER</button>
	
	<script type="text/javascript">
		createFooter();
	</script>
	

<script type="text/javascript">
	
	var USER_DETAILS = {};
	
	//ETH Wallet
	var privateKey 	= "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";
	var myEthWallet = new ethers.Wallet(privateKey);
	
	//The ABI interface
	var InterfaceABI = new ethers.utils.Interface(TOKEN_ABI.abi);
		
	//What is the Token Contract address
	var contractAddress = "0xa51c1fc2f0d1a1b8494ed1fe312d7c3a78ed91c0";
	
	function myTokenBalanceCall(toaddress, callback){
		
		//Get ETH valid address
		var address = toaddress.toLowerCase();
		if(address.startsWith("0x")){
			address = address.slice(2)
		}
		
		//Calling 'function balanceOf(address account)'
		//var functiondata = InterfaceABI.getFunction("balanceOf").encode([ address ]);
		var functiondata = InterfaceABI.functions.balanceOf.encode([ address ]);
		
		//Run this
		ethCallCommand(contractAddress,functiondata,function(ethresp){
			callback(ethresp);	
		});
	}
	
	function myTokenTransferCall(toaddress, amount, callback){
		
		//Get ETH valid address
		var address = toaddress.toLowerCase();
		if(address.startsWith("0x")){
			address = address.slice(2)
		}
		
		//Calculate the function Data Param
		var iface = new ethers.utils.Interface(TOKEN_ABI.abi);
		
		//Calling 'function balanceOf(address account)'
		var functiondata = iface.functions.transfer.encode([ address, amount ]);
		
		//Get the nonce..
		getTransactionCount(myEthWallet.address,function(txncount){
				
			//This is the nonce..
			var nonce = parseInt(txncount,16);
			
			//Now create the RAW txn..
			var transaction = createRAWContractCallTxn(contractAddress, functiondata, nonce);
			
			//NOW SIGN..
			postTransaction(myEthWallet, transaction, function(ethresp){
				MDS.log(JSON.stringify(ethresp));
			});    	
		});
	}
	
	//ethers.utils.parseEther("1.0")
	
	function deploy(){
		
		//Get my balance..
		getERC20Balance("0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",function(balance){
			MDS.log(JSON.stringify(balance));
			
			var bal = ethers.utils.formatEther(balance.result);
			
			//var bal = parseInt(balance.result,16);
			MDS.log("wMinima bal : "+bal);
		});

	}
	
	function getLogs(){
		
		/*myTokenBalanceCall("0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",function(ethresp){
			MDS.log("Balance 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266:"+JSON.stringify(ethresp));
		
			myTokenBalanceCall("0x70997970C51812dc3A010C7d01b50e0d17dc79C8",function(ethresp){
				MDS.log("Balance 0x70997970C51812dc3A010C7d01b50e0d17dc79C8:"+JSON.stringify(ethresp));
			
			});	
		});*/
		
		//Get all transfer events..
		var params = [
						{
							fromBlock:"0x10",
						 	toBlock:"latest",
						 	topics:["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"],
						 	address:contractAddress
						}
					];
		//var params = [{"address":contractAddress}];
		var payload = {"jsonrpc":"2.0", "method":"eth_getLogs",
				"params": params, "id": 1};
		  
		//Run it..
		runEthCommand(payload,function(ethresp){
			MDS.log(JSON.stringify(ethresp,null,2));
			
			var len = ethresp.result.length;
			for(var i=0;i<len;i++){
				
				var ev = ethresp.result[i];
				
				//Decode..
				var block   = parseInt(ev.blockNumber,16);
				var from 	= "0x"+ev.topics[1].substring(26);
				var to 		= "0x"+ev.topics[2].substring(26);
				
				//Decode the data
				var abidecode = new ethers.utils.AbiCoder();
				var tamt = abidecode.decode(["uint256"],ev.data);
				
				//var amount  = parseInt(ev.data,16);
				
				MDS.log("Block:"+block+" transfer from:"+from+" to:"+to+" amount:"+tamt);	
			}
		});
	}
	
	function transfer(){
		
		myTokenTransferCall("0x70997970C51812dc3A010C7d01b50e0d17dc79C8","1",function(ethresp){
			MDS.log("Transfer:"+JSON.stringify(ethresp));
		});
	}
	
	function tester(){
		
		// Get the current Nonce..
		getRequiredNonce(myEthWallet.address, function(nonce){
				
			//And now send 1 ETH
			sendETH(myEthWallet, "0x70997970C51812dc3A010C7d01b50e0d17dc79C8", 2, nonce, function(ethresp){
				
				getWeiBalance("0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",function(ethresp){
					//Convert to ETH
					var ethvalue = ethers.utils.formatEther(ethresp);
					MDS.log("0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266:"+ethvalue);
				});
				
				getWeiBalance("0x70997970C51812dc3A010C7d01b50e0d17dc79C8",function(ethresp){
					//Convert to ETH
					var ethvalue = ethers.utils.formatEther(ethresp);
					MDS.log("0x70997970C51812dc3A010C7d01b50e0d17dc79C8:"+ethvalue);
				});
			});
		});
		
		
	}
	
	//Main message handler..
	MDS.init(function(msg){
		
		//Do initialisation
		if(msg.event == "inited"){
			/*getUserDetails(function(userdets){
				USER_DETAILS=userdets;
				MDS.log(JSON.stringify(USER_DETAILS));
			});*/
		}
	});

</script>

</body>

</html>