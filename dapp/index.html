<html>

<head>
	<title>Bridge</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- Load the main MDS JS lib -->
	<script type="text/javascript" src="./js/mds.js"></script>
	
	<!-- Load the CSS Style sheet -->
	<link rel="stylesheet" href="./css/style.css">
	
	<!-- And the ICON for the page -->
	<link rel="icon" type="image/x-icon" href="favicon.ico">
	
	<!-- Load the local JS lib -->
	<script type="text/javascript" src="./js/pagelayout.js"></script>
	<script type="text/javascript" src="./js/scripts.js"></script>
	<script type="text/javascript" src="./js/jslib.js"></script>
	<script type="text/javascript" src="./js/auth.js"></script>
	<script type="text/javascript" src="./js/sql.js"></script>
	
	<script type="text/javascript" src="./js/ethers-4.0.31.min.js"></script>
	<script type="text/javascript" src="./js/ethutil.js"></script>
	
</head>

<body>

	<script type="text/javascript">
		createHeader();
	</script>
	
	Welcome to Bridge.<br>
	<br>
	Here you can Swap native Minima for wMinima on ETH.<br>
	<br>
	
	<button onclick="tester();">TEST ETH</button>
	
	<script type="text/javascript">
		createFooter();
	</script>
	

<script type="text/javascript">
	
	var USER_DETAILS = {};
	
	function tester(){
		
		MDS.log("Testing ETH functions..");
		
		//let provider = ethers.getDefaultProvider();

		getCurrentBlock(function(res){
			MDS.log("Block:"+res);	
		});
		
		
		MDS.log("Start create Wallet..");

		//let privateKey = "0x0123456789012345678901234567890123456789012345678901234567890123";
		let privateKey = "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";
		let wallet = new ethers.Wallet(privateKey);

		MDS.log("Wallet created! "+wallet.address);
		
		//MDS.log(ethers.utils.parseEther("10.0"));
		
		getTransactionCount(wallet.address,function(txncount){
			
			//This is the nonce..
			var nonce = parseInt(txncount,16);
			MDS.log("Nonce:"+nonce);
			
			var txn 		= createRAWTxn("0x70997970C51812dc3A010C7d01b50e0d17dc79C8", nonce, "1");
			var signPromise = wallet.sign(txn);

			signPromise.then((signedTransaction) => {
			    MDS.log("Signed Txn:"+signedTransaction);
			    
			    //Now send!
			    sendRAWSignedTxn(signedTransaction,function(ethresp){
			    	MDS.log("sendRAWSignedTxn:"+JSON.stringify(ethresp));
			    	
			    	getWeiBalance("0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",function(ethresp){
						//Convert to ETH
						var ethvalue = ethers.utils.formatEther(ethresp);
						MDS.log("0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266:"+ethvalue);
					});
					
					getWeiBalance("0x70997970C51812dc3A010C7d01b50e0d17dc79C8",function(ethresp){
						//Convert to ETH
						var ethvalue = ethers.utils.formatEther(ethresp);
						MDS.log("0x70997970C51812dc3A010C7d01b50e0d17dc79C8:"+ethvalue);
					});
					
			    });
			});		
		});
	}
	
	//Main message handler..
	MDS.init(function(msg){
		
		//Do initialisation
		if(msg.event == "inited"){
			/*getUserDetails(function(userdets){
				USER_DETAILS=userdets;
				MDS.log(JSON.stringify(USER_DETAILS));
			});*/
		}
	});

</script>

</body>

</html>